import{R as P,j as e,a as $,r as t}from"./assets/client-CnLxy5PC.js";const F={1:[101,102,103,104],2:[101,102,103],3:[101,102]};function O(){const[m,f]=t.useState(null),[q,A]=t.useState(()=>({...F})),[w,g]=t.useState(!1),[h,p]=t.useState([]),[C,R]=t.useState(!0),[T,i]=t.useState([]),[E,x]=t.useState(!1),[l,r]=t.useState({code:"",name:"",memo:""}),[v,u]=t.useState(""),[y,k]=t.useState(!1),[d,j]=t.useState(null),[b,S]=t.useState(!1),M=s=>{f(s),g(!0),fetch(`/opanel/access/group/${s}/permissions`).then(a=>a.json()).then(a=>{i(a.permissions||[])}).catch(()=>{window.Tabler.Toast.show("載入權限失敗",{color:"red"}),i([])}).finally(()=>{g(!1)})},D=async()=>{if(d){S(!0);try{const a=await(await fetch(`/opanel/access/roles/${d.id}`,{method:"DELETE"})).json();if(!a.success)throw new Error(a.message||"刪除失敗");p(h.filter(o=>o.id!==d.id)),window.showToast("角色已成功刪除","success"),m===d.id&&(f(null),i([])),j(null)}catch(s){window.showToast(`刪除失敗: ${s.message}`,"error")}finally{S(!1)}}},I=async s=>{s.preventDefault(),u(""),k(!0);try{const a=new URLSearchParams;a.append("code",l.code),a.append("name",l.name),a.append("memo",l.memo);const n=await(await fetch("/opanel/access/roles/create",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a})).json();if(!n.success)throw new Error(n.message||"新增失敗");p([...h,n.role]),window.showToast("角色新增成功","success"),r({code:"",name:"",memo:""}),x(!1)}catch(a){u(a.message)}finally{k(!1)}};t.useEffect(()=>{fetch("/opanel/access/roles/list").then(s=>s.json()).then(s=>{p(s.roles||[])}).catch(()=>{window.showToast("角色清單載入失敗","error")}).finally(()=>{R(!1)})},[]);const L=async({groupId:s,funcId:a,enabled:o})=>{try{const n=new URLSearchParams;n.append("groupId",Number(s)),n.append("funcId",Number(a)),n.append("enabled",o?"1":"0"),console.log("發送資料:",{groupId:Number(s),funcId:Number(a),enabled:o?"1":"0"});const N=await(await fetch("/opanel/access/update-permission",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n})).json();if(console.log("伺服器回應:",N),!N.success)throw new Error(N.message||"伺服器錯誤");window.showToast("權限已更新","success")}catch(n){window.showToast(`更新失敗: ${n.message}`,"error"),s&&fetch(`/opanel/access/group/${s}/permissions`).then(c=>c.json()).then(c=>{i(c.permissions||[])}).catch(()=>{window.showToast("重新載入權限失敗","error")})}};return e.jsxs("div",{className:"container-xl mt-4",children:[e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-3",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h3",{className:"card-title",children:"角色清單"}),e.jsx("button",{className:"btn btn-primary btn-sm",onClick:()=>x(!0),children:"新增角色"})]}),e.jsx("div",{className:"card-body",children:C?e.jsx("div",{className:"text-muted",children:"角色清單載入中..."}):h.length===0?e.jsx("div",{className:"text-danger",children:"找不到角色資料"}):h.map(s=>e.jsxs("div",{className:"d-flex mb-2 align-items-center",children:[e.jsx("button",{onClick:()=>M(s.id),className:`btn flex-grow-1 me-1 ${s.id===m?"btn-primary":"btn-outline-primary"}`,children:s.name}),e.jsx("button",{className:"btn btn-outline-danger btn-icon",title:"刪除角色",onClick:a=>{a.stopPropagation(),j(s)},children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon",width:"24",height:"24",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),e.jsx("path",{d:"M4 7l16 0"}),e.jsx("path",{d:"M10 11l0 6"}),e.jsx("path",{d:"M14 11l0 6"}),e.jsx("path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"}),e.jsx("path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"})]})})]},s.id))})]})}),e.jsx("div",{className:"col-md-9",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"card-title",children:"權限清單"})}),e.jsx("div",{className:"card-body",children:m===null?e.jsx("div",{className:"text-muted",children:"請先選擇一個角色"}):w?e.jsx("div",{className:"text-muted",children:"載入中..."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"功能名稱"}),e.jsx("th",{className:"text-end",children:"是否啟用"})]})}),e.jsx("tbody",{children:T.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.name}),e.jsx("td",{className:"text-end",children:e.jsx("input",{type:"checkbox",className:"form-check-input",checked:s.enabled===1,disabled:w,onChange:a=>{const o=a.target.checked;L({groupId:m,funcId:s.id,enabled:o}),i(n=>n.map(c=>c.id===s.id?{...c,enabled:o?1:0}:c))}})})]},s.id))})]})})]})})]}),E&&e.jsx("div",{className:"modal d-block",tabIndex:"-1",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"新增角色"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>{x(!1),u(""),r({code:"",name:"",memo:""})}})]}),e.jsxs("div",{className:"modal-body",children:[v&&e.jsx("div",{className:"alert alert-danger",children:v}),e.jsxs("form",{onSubmit:I,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"角色代碼"}),e.jsx("input",{type:"text",className:"form-control",value:l.code,onChange:s=>r({...l,code:s.target.value}),required:!0}),e.jsx("div",{className:"form-text",children:"英文字母和數字，不含空格，例如：editor"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"角色名稱"}),e.jsx("input",{type:"text",className:"form-control",value:l.name,onChange:s=>r({...l,name:s.target.value}),required:!0}),e.jsx("div",{className:"form-text",children:"顯示用名稱，例如：編輯人員"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"備註說明"}),e.jsx("textarea",{className:"form-control",value:l.memo,onChange:s=>r({...l,memo:s.target.value})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>{x(!1),u(""),r({code:"",name:"",memo:""})},children:"取消"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"處理中..."]}):"新增"})]})]})]})]})})}),d&&e.jsx("div",{className:"modal d-block",tabIndex:"-1",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:e.jsx("div",{className:"modal-dialog modal-sm",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"確認刪除"}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>j(null),disabled:b})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{children:["您確定要刪除角色「",d.name,"」嗎？"]}),e.jsx("p",{className:"text-danger",children:"此操作無法復原，角色的所有權限設定將一併刪除。"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>j(null),disabled:b,children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:D,disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"處理中..."]}):"確認刪除"})]})]})})})]})}P.createRoot(document.getElementById("roles-app")).render(e.jsx($.StrictMode,{children:e.jsx(O,{})}));
